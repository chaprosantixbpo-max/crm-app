<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Prosantix CRM</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #mainArea, #adminPanel { display:none; }
    label { font-weight:bold; }
    .hidden { display:none; }
    table { border-collapse: collapse; margin-top:10px; }
    table td, table th { border: 1px solid #ccc; padding:6px 8px; }
  </style>
</head>
<body>

<h2>CRM Login</h2>
<div id="loginArea">
  <input id="loginUser" placeholder="Username"><br><br>
  <input id="loginPass" placeholder="Password" type="password"><br><br>
  <button id="btnLogin">Login</button>
  <button id="btnDemo">Demo</button>
  <p id="loginMsg" style="color:red; display:none;"></p>
</div>

<div id="mainArea">
  <h3>Welcome, <span id="agentName"></span></h3>
  <button id="btnLogout">Logout</button>
  <hr>

  <h3>Lookup Customer</h3>
  <input id="lookupPhone" placeholder="Enter phone #">
  <button id="btnLookup">Lookup</button>
  <div id="customerBox" class="hidden">
    <h4>Customer Details</h4>
    <div id="cust"></div>
  </div>

  <hr>
  <h3>Questions</h3>

  <label>Military Opening</label>
  <select id="militaryOpening"><option></option><option>Yes</option><option>No</option><option>Unsure</option></select><br><br>

  <label>Military Q1</label>
  <select id="militaryQ1"><option></option><option>You</option><option>Household</option><option>No</option><option>Unsure</option></select><br><br>

  <label>Military Q2</label>
  <select id="militaryQ2"><option></option><option>Army</option><option>Navy</option><option>Airforce</option><option>Reservists / TA</option></select><br><br>

  <label>Military Q3</label>
  <select id="militaryQ3"><option></option><option>After 1987</option><option>Before 1987</option><option>Still serving</option><option>Retired</option></select><br><br>

  <label>Scotland Q1</label>
  <select id="scotlandQ1"><option></option><option>Yes</option><option>No</option><option>Unsure</option></select><br><br>

  <label>Scotland Q2</label>
  <select id="scotlandQ2"><option></option><option>Children’s Home</option><option>Residential School</option><option>Foster Care</option><option>Another setting</option></select><br><br>

  <label>UK Q1</label>
  <select id="ukQ1"><option></option><option>Yes</option><option>No</option><option>Unsure</option></select><br><br>

  <label>UK Q2</label>
  <select id="ukQ2"><option></option><option>Children’s Home</option><option>School</option><option>Sunday School</option><option>Youth Group</option><option>Church Activity</option></select><br><br>

  <label>Notes</label><br>
  <textarea id="notes" rows="3" cols="40"></textarea><br><br>

  <label>Disposition</label>
  <select id="disposition"><option></option><option>Lead</option><option>Callback</option><option>Not Interested</option></select><br><br>

  <button id="btnSave">SAVE</button>

  <hr>

  <div id="adminPanel">
    <h3>Admin Panel</h3>
    <button id="btnLoadResponses">Load All Saved Leads</button>
    <div id="responseTable"></div>
  </div>

</div>

<script>
  const el = id => document.getElementById(id);
  let currentCustomer = null;

  // Simple SHA-256 helper (returns hex)
  async function sha256Hex(text) {
    const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,'0')).join('');
  }

  function showLoginMsg(m) {
    el("loginMsg").innerText = m;
    el("loginMsg").style.display = "block";
    setTimeout(()=> el("loginMsg").style.display="none", 3000);
  }

  // Login
  el("btnLogin").addEventListener("click", async () => {
    const username = el("loginUser").value.trim();
    const pass = el("loginPass").value;
    if (!username || !pass) return showLoginMsg("Enter username & password");

    const passHash = await sha256Hex(pass);

    google.script.run.withSuccessHandler(res => {
      if (res && res.success) {
        localStorage.setItem("crm_user", JSON.stringify({ username, role: res.role, token: res.token || "" }));
        setupAfterLogin();
      } else {
        showLoginMsg("Invalid login");
      }
    }).server_login({ username, password: passHash, rawPassword: pass });
  });

  el("btnDemo").addEventListener("click", () => {
    el("loginUser").value = "Agent01";
    el("loginPass").value = "1001";
    el("btnLogin").click();
  });

  function setupAfterLogin() {
    const user = JSON.parse(localStorage.getItem("crm_user")||"{}");
    if (!user || !user.username) return;
    el("loginArea").style.display = "none";
    el("mainArea").style.display = "block";
    el("agentName").innerText = user.username;
    if ((user.role||"").toLowerCase() === "admin") el("adminPanel").style.display = "block";
    else el("adminPanel").style.display = "none";
  }

  el("btnLogout").addEventListener("click", () => {
    localStorage.removeItem("crm_user");
    location.reload();
  });

  // Lookup
  el("btnLookup").addEventListener("click", () => {
    const phone = el("lookupPhone").value.trim();
    if (!phone) return alert("Enter phone");
    google.script.run.withSuccessHandler(data => {
      if (!data) { alert("Not found"); el("customerBox").classList.add("hidden"); currentCustomer=null; return; }
      currentCustomer = data;
      el("cust").innerHTML = `<b>${data.title||""} ${data.firstName||""} ${data.lastName||""}</b><br>
        ${data.address1||""}<br>${data.address2||""}<br>${data.address3||""}<br>${data.county||""}<br>${data.postcode||""}<br>
        Age: ${data.age||""}<br>Phone: ${data.telephone||""}`;
      el("customerBox").classList.remove("hidden");
    }).server_lookup(phone);
  });

  // Save
  el("btnSave").addEventListener("click", () => {
    const user = JSON.parse(localStorage.getItem("crm_user")||"{}");
    if (!user || !user.username) return showLoginMsg("Please login first");

    const payload = {
      phone: el("lookupPhone").value.trim(),
      title: currentCustomer ? currentCustomer.title : "",
      firstName: currentCustomer ? currentCustomer.firstName : "",
      lastName: currentCustomer ? currentCustomer.lastName : "",
      telephone: currentCustomer ? currentCustomer.telephone : "",
      address1: currentCustomer ? currentCustomer.address1 : "",
      address2: currentCustomer ? currentCustomer.address2 : "",
      address3: currentCustomer ? currentCustomer.address3 : "",
      county: currentCustomer ? currentCustomer.county : "",
      postcode: currentCustomer ? currentCustomer.postcode : "",
      age: currentCustomer ? currentCustomer.age : "",

      militaryOpening: el("militaryOpening").value,
      militaryQ1: el("militaryQ1").value,
      militaryQ2: el("militaryQ2").value,
      militaryQ3: el("militaryQ3").value,
      scotlandQ1: el("scotlandQ1").value,
      scotlandQ2: el("scotlandQ2").value,
      ukQ1: el("ukQ1").value,
      ukQ2: el("ukQ2").value,
      notes: el("notes").value,
      disposition: el("disposition").value,
      agent: user.username
    };

    google.script.run.withSuccessHandler(r => {
      if (r && r.ok) {
        alert("Saved!");
        el("notes").value = "";
        el("disposition").value = "";
      } else {
        alert("Saved (server returned unexpected response)");
      }
    }).server_saveLead(payload);
  });

  // Admin: load responses
  el("btnLoadResponses").addEventListener("click", () => {
    google.script.run.withSuccessHandler(j => {
      if (!j || !j.length) { el("responseTable").innerText = "No results"; return; }
      let html = "<table><tr>";
      j[0].forEach(h => html += `<th>${h}</th>`);
      html += "</tr>";
      for (let r = 1; r < j.length; r++) {
        html += "<tr>";
        j[r].forEach(c => html += `<td>${c}</td>`);
        html += "</tr>";
      }
      html += "</table>";
      el("responseTable").innerHTML = html;
    }).server_fetchResponses();
  });

  // Initialize UI on load (if logged-in)
  window.addEventListener("load", setupAfterLogin);
</script>

</body>
</html>
