<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Agent CRM</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;max-width:920px;margin:18px auto;padding:18px;}
    label{display:block;margin-top:10px;font-weight:600}
    input,select,textarea{width:100%;padding:8px;margin-top:6px;box-sizing:border-box}
    button{padding:8px 12px;margin-top:8px}
    #crm-status{margin-top:8px;font-weight:600;color:#153}
    .hidden{display:none}
    #crm-customer p{margin:6px 0}
    .small { font-size:0.9em; color:#666; margin-top:6px }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>Agent CRM — Login required</h2>

  <div id="g-signin"></div>
  <p id="signed-as" class="hidden">Signed in as: <strong id="user-email"></strong> (<span id="user-role"></span>)</p>

  <div id="crm-app" class="hidden">
    <label>Phone Lookup</label>
    <input id="crm-phone" type="text" />
    <button id="crm-lookup">Lookup</button>

    <div id="crm-customer" style="margin-top:12px;">
      <p class="small">Customer info (auto-filled from Customers sheet)</p>
      <p><strong>Title:</strong> <span id="crm-title"></span></p>
      <p><strong>First Name:</strong> <span id="crm-first"></span></p>
      <p><strong>Last Name:</strong> <span id="crm-last"></span></p>
      <p><strong>Telephone:</strong> <span id="crm-tel"></span></p>
      <p><strong>Address1:</strong> <span id="crm-addr1"></span></p>
      <p><strong>Address2:</strong> <span id="crm-addr2"></span></p>
      <p><strong>Address3:</strong> <span id="crm-addr3"></span></p>
      <p><strong>County:</strong> <span id="crm-county"></span></p>
      <p><strong>Postcode:</strong> <span id="crm-postcode"></span></p>
      <p><strong>Age:</strong> <span id="crm-age"></span></p>
    </div>

    <label>Military Opening</label>
    <select id="mil-opening"><option value="">--</option><option>YES</option><option>NO</option></select>

    <label>Military Q1</label>
    <select id="mil-q1"><option value="">--</option><option>You</option><option>Household</option><option>None</option></select>

    <label>Military Q2</label>
    <select id="mil-q2"><option value="">--</option><option>Army</option><option>Navy</option><option>Airforce</option><option>Reservists / TA</option><option>None</option></select>

    <label>Military Q3</label>
    <select id="mil-q3"><option value="">--</option><option>Before 1987</option><option>After 1987</option><option>Still serving</option><option>Retired</option><option>None</option></select>

    <div id="scotland-block">
      <label>Scotland Q1</label>
      <select id="scot-q1"><option value="">--</option><option>Yes</option><option>No</option></select>
      <label>Scotland Q2</label>
      <select id="scot-q2"><option value="">--</option><option>Children’s Home</option><option>Residential School</option><option>Foster Care</option><option>Another Setting</option><option>None</option></select>
    </div>

    <div id="uk-block">
      <label>UK Q1</label>
      <select id="uk-q1"><option value="">--</option><option>Yes</option><option>No</option></select>
      <label>UK Q2</label>
      <select id="uk-q2"><option value="">--</option><option>Children’s Home</option><option>School</option><option>Sunday School</option><option>Youth Group</option><option>Church Activity</option><option>Other</option><option>None</option></select>
    </div>

    <label>Notes</label>
    <textarea id="crm-notes"></textarea>

    <label>Disposition</label>
    <select id="crm-dispo"><option value="">--</option><option>Lead</option><option>Non-Lead</option><option>Callback</option><option>Wrong Number</option></select>

    <br/><br/>
    <button id="crm-save">Save Call</button>
    <div id="crm-status"></div>
  </div>

<script>
  // ===== CONFIG: your Apps Script and Client ID =====
  const WEBAPP = 'https://script.google.com/macros/s/AKfycbyX6wTNU1HuXYDPkG3j-H-k7ZcZQjLFGe5BMh3SZ60TMipk3JTFKlc3X5xWmYtXeTN7/exec';
  const CLIENT_ID = '465169087704-0ar896eain19i5dd9asan7b7c76gn7tb.apps.googleusercontent.com';
  // ==================================================

  let currentIdToken = null;

  window.onload = function() {
    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: handleCredentialResponse,
      ux_mode: 'popup'
    });
    google.accounts.id.renderButton(
      document.getElementById('g-signin'),
      { theme: 'outline', size: 'large' }
    );
    google.accounts.id.prompt();
  };

  function handleCredentialResponse(response) {
    currentIdToken = response.credential;
    // quick decode
    const payload = parseJwt(currentIdToken);
    document.getElementById('user-email').innerText = (payload.email || '');
    // verify role & show app
    fetch(WEBAPP + '?phone=&id_token=' + encodeURIComponent(currentIdToken))
      .then(r => r.json()).then(data => {
        if (data.userEmail && data.userRole) {
          document.getElementById('signed-as').classList.remove('hidden');
          document.getElementById('user-email').innerText = data.userEmail;
          document.getElementById('user-role').innerText = data.userRole;
          document.getElementById('crm-app').classList.remove('hidden');
          document.getElementById('crm-status').innerText = '';
        } else {
          document.getElementById('crm-status').innerText = 'Access denied — your account is not registered in Users sheet.';
        }
      }).catch(err => { console.error(err); document.getElementById('crm-status').innerText = 'Auth check failed'; });
  }

  function parseJwt (token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
  }

  document.getElementById('crm-lookup').addEventListener('click', function(){
    const phone = document.getElementById('crm-phone').value.trim();
    if (!phone) { document.getElementById('crm-status').innerText = 'Enter phone number'; return; }
    if (!currentIdToken) { document.getElementById('crm-status').innerText = 'Please sign in first'; return; }
    document.getElementById('crm-status').innerText = 'Looking up...';
    fetch(WEBAPP + '?phone=' + encodeURIComponent(phone) + '&id_token=' + encodeURIComponent(currentIdToken))
      .then(r => r.json()).then(data => {
        if (data.error) { document.getElementById('crm-status').innerText = 'Not found or access denied: ' + data.error; clearCustomer(); return; }
        fillCustomer(data);
        document.getElementById('crm-status').innerText = 'Found';
        applyPostcodeLogic();
      }).catch(err => { console.error(err); document.getElementById('crm-status').innerText = 'Lookup error'; });
  });

  document.getElementById('crm-save').addEventListener('click', function(){
    const phone = document.getElementById('crm-phone').value.trim();
    if (!phone) { alert('Please enter phone'); return; }
    if (!currentIdToken) { alert('Please sign in'); return; }

    const payload = {
      id_token: currentIdToken,
      phone: phone,
      title: document.getElementById('crm-title').innerText,
      firstName: document.getElementById('crm-first').innerText,
      lastName: document.getElementById('crm-last').innerText,
      telephone: document.getElementById('crm-tel').innerText,
      address1: document.getElementById('crm-addr1').innerText,
      address2: document.getElementById('crm-addr2').innerText,
      address3: document.getElementById('crm-addr3').innerText,
      county: document.getElementById('crm-county').innerText,
      postcode: document.getElementById('crm-postcode').innerText,
      age: document.getElementById('crm-age').innerText,
      militaryOpening: document.getElementById('mil-opening').value,
      militaryQ1: document.getElementById('mil-q1').value,
      militaryQ2: document.getElementById('mil-q2').value,
      militaryQ3: document.getElementById('mil-q3').value,
      scotlandQ1: document.getElementById('scot-q1').value,
      scotlandQ2: document.getElementById('scot-q2').value,
      ukQ1: document.getElementById('uk-q1').value,
      ukQ2: document.getElementById('uk-q2').value,
      notes: document.getElementById('crm-notes').value,
      disposition: document.getElementById('crm-dispo').value
    };

    document.getElementById('crm-status').innerText = 'Saving...';
    fetch(WEBAPP, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    }).then(r => r.json()).then(data => {
      if (data.ok) {
        document.getElementById('crm-status').innerText = 'Saved';
        resetForm();
      } else {
        document.getElementById('crm-status').innerText = 'Save failed: ' + (data.error || data.message || 'unknown');
      }
    }).catch(err => { console.error(err); document.getElementById('crm-status').innerText = 'Save error'; });
  });

  function fillCustomer(d){
    document.getElementById('crm-title').innerText = d.title || '';
    document.getElementById('crm-first').innerText = d.firstName || '';
    document.getElementById('crm-last').innerText = d.lastName || '';
    document.getElementById('crm-tel').innerText = d.telephone || '';
    document.getElementById('crm-addr1').innerText = d.address1 || '';
    document.getElementById('crm-addr2').innerText = d.address2 || '';
    document.getElementById('crm-addr3').innerText = d.address3 || '';
    document.getElementById('crm-county').innerText = d.county || '';
    document.getElementById('crm-postcode').innerText = d.postcode || '';
    document.getElementById('crm-age').innerText = d.age || '';
  }

  function clearCustomer(){
    ['title','first','last','tel','addr1','addr2','addr3','county','postcode','age'].forEach(k=>{
      const el = document.getElementById('crm-'+k);
      if(el) el.innerText = '';
    });
  }

  function resetForm(){
    document.getElementById('crm-phone').value = '';
    clearCustomer();
    ['mil-opening','mil-q1','mil-q2','mil-q3','scot-q1','scot-q2','uk-q1','uk-q2','crm-notes','crm-dispo'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });
    document.getElementById('scotland-block').style.display = '';
    document.getElementById('uk-block').style.display = '';
  }

  function applyPostcodeLogic(){
    const pc = document.getElementById('crm-postcode').innerText.toUpperCase().trim();
    const scPrefixes = ["AB","DD","DG","EH","FK","G","HS","IV","KA","KW","KY","ML","PA","PH","TD","ZE"];
    if(pc === '') { document.getElementById('scotland-block').style.display=''; document.getElementById('uk-block').style.display=''; return; }
    const isSc = scPrefixes.some(p => pc.startsWith(p));
    if(isSc){ document.getElementById('scotland-block').style.display=''; document.getElementById('uk-block').style.display='none'; }
    else { document.getElementById('scotland-block').style.display='none'; document.getElementById('uk-block').style.display=''; }
  }
</script>
</body>
</html>
