<!DOCTYPE html>
<html>
<head>
<title>CRM Login</title>
<style>
    body { font-family: Arial; margin: 20px; }
    #mainArea, #adminPanel { display: none; }
    label { font-weight: bold; }
    .hidden { display:none; }
</style>
</head>

<body>

<h2>CRM Login</h2>

<!-- ================= LOGIN AREA ================= -->
<div id="loginArea">
    <input id="loginUser" placeholder="Username"><br><br>
    <input id="loginPass" placeholder="Password" type="password"><br><br>
    <button id="btnLogin">Login</button>
    <button id="btnDemo">Demo</button>
    <p id="loginMsg" style="color:red; display:none;"></p>
</div>

<!-- ================= MAIN CRM AREA ================= -->
<div id="mainArea">

    <h3>Welcome, <span id="agentName"></span></h3>
    <button onclick="logout()">Logout</button>
    <hr>

    <h3>Lookup Customer</h3>
    <input id="lookupPhone" placeholder="Enter phone #">
    <button id="btnLookup">Lookup</button>

    <div id="customerBox" class="hidden">
        <h3>Customer Details</h3>
        <div id="cust"></div>
    </div>

    <hr>
    <h3>Questions</h3>

    <label>Military Opening</label>
    <select id="militaryOpening">
        <option></option>
        <option>Yes</option>
        <option>No</option>
        <option>Unsure</option>
    </select><br><br>

    <label>Military Q1</label>
    <select id="militaryQ1">
        <option></option>
        <option>You</option>
        <option>Household</option>
        <option>No</option>
        <option>Unsure</option>
    </select><br><br>

    <label>Military Q2</label>
    <select id="militaryQ2">
        <option></option>
        <option>Army</option>
        <option>Navy</option>
        <option>Airforce</option>
        <option>Reservists / TA</option>
    </select><br><br>

    <label>Military Q3</label>
    <select id="militaryQ3">
        <option></option>
        <option>After 1987</option>
        <option>Before 1987</option>
        <option>Still serving</option>
        <option>Retired</option>
    </select><br><br>

    <label>Scotland Q1</label>
    <select id="scotlandQ1">
        <option></option>
        <option>Yes</option>
        <option>No</option>
        <option>Unsure</option>
    </select><br><br>

    <label>Scotland Q2</label>
    <select id="scotlandQ2">
        <option></option>
        <option>Children’s Home</option>
        <option>Residential School</option>
        <option>Foster Care</option>
        <option>Another setting</option>
    </select><br><br>

    <label>UK Q1</label>
    <select id="ukQ1">
        <option></option>
        <option>Yes</option>
        <option>No</option>
        <option>Unsure</option>
    </select><br><br>

    <label>UK Q2</label>
    <select id="ukQ2">
        <option></option>
        <option>Children’s Home</option>
        <option>School</option>
        <option>Sunday School</option>
        <option>Youth Group</option>
        <option>Church Activity</option>
    </select><br><br>

    <label>Notes</label><br>
    <textarea id="notes" rows="3" cols="40"></textarea><br><br>

    <label>Disposition</label>
    <select id="disposition">
        <option></option>
        <option>Lead</option>
        <option>Callback</option>
        <option>Not Interested</option>
    </select><br><br>

    <button id="btnSave">SAVE</button>

    <hr>

    <!-- ================= ADMIN PANEL ================= -->
    <div id="adminPanel">
        <h2>Admin Panel</h2>
        <button id="btnLoadResponses">Load All Saved Leads</button>
        <div id="responseTable"></div>
    </div>

</div>

<!-- ================= SCRIPT ================= -->
<script>

/* CONFIG */
const API_URL = "https://script.google.com/macros/s/AKfycbwOmOk6FL59mZSuK6J7tS9u3TLa27_0we8iV2PShusLumJ0BemGwdnfobucEFMtFPY-/exec";   // <-- REPLACE with your Web App URL

const el = id => document.getElementById(id);

/* ============================================================
   SHA-256 (client-side hashing)
   ============================================================ */
async function sha256Hex(text) {
    const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, '0')).join('');
}

/* ================= state ================= */
let currentCustomer = null;

/* ================= LOGIN ================= */
el("btnLogin").addEventListener("click", async () => {
    const user = el("loginUser").value.trim();
    const pass = el("loginPass").value.trim();
    if (!user || !pass) return showLoginMsg("Enter username & password");

    // hash client-side (keeps compatibility & security)
    const passHash = await sha256Hex(pass);

    const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "login", username: user, password: passHash, rawPassword: pass })
        // note: we send both hashed and raw versions so server can handle older plaintext rows
    });

    const j = await res.json();

    if (j.success) {
        // store token + role
        localStorage.setItem("crm_user", JSON.stringify({ username: user, role: j.role, token: j.token || "" }));
        setupAfterLogin();
    } else {
        showLoginMsg("Invalid login");
    }
});

el("btnDemo").addEventListener("click", () => {
    // Demo values — change to match your sheet if needed
    el("loginUser").value = "Agent01";
    el("loginPass").value = "1001";
    el("btnLogin").click();
});

function showLoginMsg(m) {
    el("loginMsg").innerText = m;
    el("loginMsg").style.display = "block";
    setTimeout(() => el("loginMsg").style.display = "none", 3000);
}

/* ================= LOOKUP ================= */
el("btnLookup").addEventListener("click", lookupNow);

async function lookupNow() {
    const phone = el("lookupPhone").value.trim();
    if (!phone) return showLoginMsg("Enter phone to lookup");

    const res = await fetch(`${API_URL}?phone=${encodeURIComponent(phone)}`);
    const data = await res.json();

    if (data.error) {
        alert("Not found");
        el("customerBox").classList.add("hidden");
        currentCustomer = null;
        return;
    }

    currentCustomer = data; // save full customer object for saves

    let html = `
        <b>${data.title || ""} ${data.firstName || ""} ${data.lastName || ""}</b><br>
        ${data.address1 || ""}<br>
        ${data.address2 || ""}<br>
        ${data.address3 || ""}<br>
        ${data.county || ""}<br>
        ${data.postcode || ""}<br>
        Age: ${data.age || ""}<br>
        Phone: ${data.telephone || ""}
    `;

    el("cust").innerHTML = html;
    el("customerBox").classList.remove("hidden");
}

/* ================= SAVE ================= */
el("btnSave").addEventListener("click", saveNow);

async function saveNow() {
    const user = JSON.parse(localStorage.getItem("crm_user") || "{}");
    if (!user || !user.username) return showLoginMsg("Please login before saving");

    // build payload including full customer fields (if available)
    const data = {
        phone: el("lookupPhone").value.trim(),

        title: currentCustomer ? currentCustomer.title || "" : "",
        firstName: currentCustomer ? currentCustomer.firstName || "" : "",
        lastName: currentCustomer ? currentCustomer.lastName || "" : "",
        telephone: currentCustomer ? currentCustomer.telephone || "" : "",
        address1: currentCustomer ? currentCustomer.address1 || "" : "",
        address2: currentCustomer ? currentCustomer.address2 || "" : "",
        address3: currentCustomer ? currentCustomer.address3 || "" : "",
        county: currentCustomer ? currentCustomer.county || "" : "",
        postcode: currentCustomer ? currentCustomer.postcode || "" : "",
        age: currentCustomer ? currentCustomer.age || "" : "",

        militaryOpening: el("militaryOpening").value,
        militaryQ1: el("militaryQ1").value,
        militaryQ2: el("militaryQ2").value,
        militaryQ3: el("militaryQ3").value,
        scotlandQ1: el("scotlandQ1").value,
        scotlandQ2: el("scotlandQ2").value,
        ukQ1: el("ukQ1").value,
        ukQ2: el("ukQ2").value,
        notes: el("notes").value,
        disposition: el("disposition").value,
        agent: user.username
    };

    const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    });

    // server returns plain OK body for success; try to parse if json
    try {
        const txt = await res.text();
        if (txt && txt.toLowerCase().indexOf('ok') !== -1) {
            alert("Saved!");
            // clear fields (optional)
            el("notes").value = "";
            el("disposition").value = "";
        } else {
            // try json parse
            const j = JSON.parse(txt);
            if (j && !j.error) alert("Saved!");
            else alert("Saved (server returned unexpected response)");
        }
    } catch (e) {
        alert("Saved!");
    }
}

/* ================= ADMIN PANEL ================= */
el("btnLoadResponses").addEventListener("click", loadResponses);

async function loadResponses() {
    const res = await fetch(`${API_URL}?action=fetch_responses`);
    const j = await res.json();

    if (!j.values) {
        el("responseTable").innerText = "No results";
        return;
    }

    let html = "<table border='1' cellpadding='5'>";
    j.values.forEach(row => {
        html += "<tr>";
        row.forEach(col => html += `<td>${col}</td>`);
        html += "</tr>";
    });
    html += "</table>";

    el("responseTable").innerHTML = html;
}

/* ================= SESSION ================= */
window.addEventListener("load", () => {
    const user = localStorage.getItem("crm_user");
    if (user) setupAfterLogin();
});

function setupAfterLogin() {
    const user = JSON.parse(localStorage.getItem("crm_user") || "{}");
    if (!user || !user.username) return;

    el("loginArea").style.display = "none";
    el("mainArea").style.display = "block";
    el("agentName").innerText = user.username;

    if ((user.role || "").toString().toLowerCase() === "admin") {
        el("adminPanel").style.display = "block";
    } else {
        el("adminPanel").style.display = "none";
    }
}

function logout() {
    localStorage.removeItem("crm_user");
    location.reload();
}

</script>

</body>
</html>
